<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Serviços</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/public/listagens.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container col-12 col-sm-11 col-md-8">
        <h1 class="text-center">Lista de Solicitações / Serviços</h1>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Mecânico</th>
                        <th>Veículo</th>
                        <th>Cliente</th>
                        <th>Peça</th>
                        <th>Tipo Pagto</th>
                        <th>Desconto</th>
                        <th>Serviço</th>
                        <th>Descrição</th>
                        <th>Status</th>
                        <% if (gerente === true) { %>
                            <th>Modificar status</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <% Servico.forEach(servico => { %>
                        <tr>
                            <td><%= servico.Mecanico ? servico.Mecanico.nome : '' %></td>
                            <td><%= servico.Veiculo ? servico.Veiculo.modelo : '' %></td>
                            <td><%= servico.Veiculo && servico.Veiculo.Cliente ? servico.Veiculo.Cliente.nome : '' %></td>
                            <td><%= servico.Peca ? servico.Peca.nome : '' %></td>
                            <td>
                                <% if (servico.tipo_pagamento == 0) { %>
                                    Crédito
                                <% } else if (servico.tipo_pagamento == 1) { %>
                                    Débito
                                <% } else if (servico.tipo_pagamento == 2) { %>
                                    Dinheiro/PIX
                                <% } else { %>
                                    -
                                <% } %>
                            </td>
                            <td><%= servico.desconto || '-' %></td>
                            <td><%= servico.Catalogo ? servico.Catalogo.nome : '' %></td>
                            <td><%= servico.descricao || '-' %></td>
                            <td><%= servico.status %></td>

                            <% if (gerente === true) { %>
                                <td class="text-center">
                                  <div class="d-flex justify-content-center">
                                    <button type="button" class="btn btn-sm btn-primary btn-aprovar-servico"
                                            data-id="<%= servico.id %>"
                                            data-nome="<%= (servico.Catalogo ? servico.Catalogo.nome : '').replace(/\"/g,'&quot;') %>">
                                      Alterar status
                                    </button>
                                  </div>
                                  <div class="mt-2 confirm-servico" style="min-height:2rem;"></div>
                                </td>
                            <% } %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <br><br>
        <div class="d-flex justify-content-center">
            <% if (typeof mecanico !== 'undefined' && mecanico) { %>
                <a href="/mecanico/painelMecanico" class="btn btn-danger">Voltar</a>
            <% } else { %>
                <a href="/gerente/painelGerente" class="btn btn-danger">Voltar</a>
            <% } %>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-aprovar-servico').forEach(btn => {
          const row = btn.closest('tr');
          const confirmBox = row.querySelector('.confirm-servico');

          btn.addEventListener('click', () => {
            confirmBox.innerHTML = '';
            const id = btn.dataset.id;
            const nome = btn.dataset.nome || '';

            const wrapper = document.createElement('div');
            wrapper.className = 'd-flex gap-2 align-items-center';

            const info = document.createElement('span');
            info.textContent = `Alterar status da solicitação "${nome}"`;

            const aprovar = document.createElement('button');
            aprovar.className = 'btn btn-sm btn-success';
            aprovar.textContent = 'Aprovar';

            const recusar = document.createElement('button');
            recusar.className = 'btn btn-sm btn-danger';
            recusar.textContent = 'Recusar';

            const cancelar = document.createElement('button');
            cancelar.className = 'btn btn-sm btn-outline-dark';
            cancelar.textContent = 'Cancelar';

            wrapper.appendChild(info);
            wrapper.appendChild(aprovar);
            wrapper.appendChild(recusar);
            wrapper.appendChild(cancelar);
            confirmBox.appendChild(wrapper);

            async function send(status) {
              try {
                const res = await fetch('/gerente/servicos/solicitacoes', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ solicitacaoId: id, status })
                });
                const json = await res.json();
                confirmBox.innerHTML = '';
                const span = document.createElement('span');
                if (res.ok && json.ok) {
                  span.className = 'badge bg-success';
                  span.textContent = json.message || 'Status alterado';
                  const statusCell = row.querySelector('td:nth-child(7)');
                  if (statusCell) statusCell.innerHTML = `<span class="badge bg-success">${status}</span>`;
                } else {
                  span.className = 'badge bg-danger';
                  span.textContent = json.message || 'Erro';
                }
                confirmBox.appendChild(span);
                setTimeout(() => span.remove(), 3500);
              } catch (err) {
                confirmBox.innerHTML = '';
                const span = document.createElement('span');
                span.className = 'badge bg-danger';
                span.textContent = 'Erro de rede';
                confirmBox.appendChild(span);
                setTimeout(() => span.remove(), 3500);
              }
            }

            aprovar.addEventListener('click', () => send('APROVADO'));
            recusar.addEventListener('click', () => send('REJEITADO'));
            cancelar.addEventListener('click', () => { confirmBox.innerHTML = ''; });
          });
        });
      });
    </script>
</body>
</html>