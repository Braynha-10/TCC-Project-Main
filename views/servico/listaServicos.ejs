<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Serviços</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/public/listagens.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container col-12 col-sm-11 col-md-8">
        <h1 class="text-center">Lista de Solicitações / Serviços</h1>
    <form method="GET" class="d-flex mb-3">
        <input
            type="text"
            name="search"
            class="form-control"
            placeholder="Buscar por descrição, status, cliente..."
            value="<%= search %>"
        >
        <button class="btn btn-primary ms-2">Buscar</button>
    </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Mecânico</th>
                        <th>Veículo</th>
                        <th>Cliente</th>
                        <th>Peça</th>
                        <th>Tipo Pagto</th>
                        <th>Desconto</th>
                        <th>Serviço</th>
                        <th>Descrição</th>
                        <th>Status</th>
                        <% if (gerente === true) { %>
                            <th>Modificar status</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <% Servico.forEach(servico => { %>
                        <tr>
                            <td><%= servico.Mecanico ? servico.Mecanico.nome : '' %></td>
                            <td><%= servico.Veiculo ? servico.Veiculo.modelo : '' %></td>
                            <td><%= servico.Veiculo && servico.Veiculo.Cliente ? servico.Veiculo.Cliente.nome : '' %></td>
                            <td><%= servico.Peca ? servico.Peca.nome : '' %></td>
                            <td>
                                <% if (servico.tipo_pagamento == 0) { %>
                                    Crédito
                                <% } else if (servico.tipo_pagamento == 1) { %>
                                    Débito
                                <% } else if (servico.tipo_pagamento == 2) { %>
                                    Dinheiro/PIX
                                <% } else { %>
                                    -
                                <% } %>
                            </td>
                            <td><%= servico.desconto || '-' %></td>
                            <td><%= servico.Catalogo ? servico.Catalogo.nome : '' %></td>
                            <td><%= servico.descricao || '-' %></td>
                            <td><%= servico.status %></td>

                            <% if (gerente === true) { %>
                                <td class="text-center">
                                  <div class="d-flex justify-content-center">
                                    <button type="button" class="btn btn-sm btn-primary btn-aprovar-servico"
                                            data-id="<%= servico.id %>"
                                            data-nome="<%= (servico.Catalogo ? servico.Catalogo.nome : '').replace(/\"/g,'&quot;') %>">
                                      Alterar status
                                    </button>
                                  </div>
                                  <div class="mt-2 confirm-servico" style="min-height:2rem;"></div>
                                </td>
                            <% } %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-center mt-4">
            <nav>
                <ul class="pagination">

                    <% if (page > 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= page - 1 %>&search=<%= search %>">Anterior</a>
                        </li>
                    <% } %>

                    <% for (let p = 1; p <= totalPages; p++) { %>
                        <li class="page-item <%= p === page ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= p %>&search=<%= search %>"><%= p %></a>
                        </li>
                    <% } %>

                    <% if (page < totalPages) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= page + 1 %>&search=<%= search %>">Próximo</a>
                        </li>
                    <% } %>

                </ul>
            </nav>
        </div>

        <br><br>
        <div class="d-flex justify-content-center">
            <% if (typeof mecanico !== 'undefined' && mecanico) { %>
                <a href="/mecanico/painelMecanico" class="btn btn-danger">Voltar</a>
            <% } else { %>
                <a href="/gerente/painelGerente" class="btn btn-danger">Voltar</a>
            <% } %>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-aprovar-servico').forEach(btn => {
          const row = btn.closest('tr');
          const confirmBox = row.querySelector('.confirm-servico');

          btn.addEventListener('click', () => {
            confirmBox.innerHTML = '';
            const id = btn.dataset.id;
            const nome = btn.dataset.nome || '';

            const wrapper = document.createElement('div');
            wrapper.className = 'd-flex gap-2 align-items-center';

            const info = document.createElement('span');
            info.textContent = `Alterar status da solicitação "${nome}"`;

            const aprovar = document.createElement('button');
            aprovar.className = 'btn btn-sm btn-success';
            aprovar.textContent = 'Aprovar';

            const recusar = document.createElement('button');
            recusar.className = 'btn btn-sm btn-danger';
            recusar.textContent = 'Recusar';

            const cancelar = document.createElement('button');
            cancelar.className = 'btn btn-sm btn-outline-dark';
            cancelar.textContent = 'Cancelar';

            wrapper.appendChild(info);
            wrapper.appendChild(aprovar);
            wrapper.appendChild(recusar);
            wrapper.appendChild(cancelar);
            confirmBox.appendChild(wrapper);

            async function send(status) {
            try {
              const res = await fetch('/gerente/servicos/solicitacoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ solicitacaoId: id, status })
              });

              // tenta ler resposta de forma segura
              const contentType = res.headers.get('content-type') || '';
              let json = null;
              if (contentType.includes('application/json')) {
                json = await res.json();
              } else {
                // se não for JSON, tentar texto (por segurança)
                const text = await res.text();
                // opcional: console para debug
                console.log('Resposta não-JSON do servidor:', text);
              }

              confirmBox.innerHTML = '';
              const span = document.createElement('span');

              if (res.ok && json && json.ok) {
                span.className = 'badge bg-success';
                span.textContent = json.message || 'Status alterado';
                // atualiza célula do status na tabela
                const statusCell = row.querySelector('td:nth-child(9)'); // coluna de Status (ajuste se necessário)
                if (statusCell) statusCell.innerHTML = `<span class="badge bg-success">${status}</span>`;
              } else if (res.ok && !json) {
                // caso de redirect ou resposta em HTML mas com OK
                span.className = 'badge bg-success';
                span.textContent = 'Operação concluída';
              } else {
                span.className = 'badge bg-danger';
                span.textContent = (json && json.message) ? json.message : 'Erro';
              }

              confirmBox.appendChild(span);
              setTimeout(() => span.remove(), 3500);
            } catch (err) {
              console.error('Erro fetch:', err);
              confirmBox.innerHTML = '';
              const span = document.createElement('span');
              span.className = 'badge bg-danger';
              span.textContent = 'Erro de rede';
              confirmBox.appendChild(span);
              setTimeout(() => span.remove(), 3500);
            }
          }


            aprovar.addEventListener('click', () => send('APROVADO'));
            recusar.addEventListener('click', () => send('REJEITADO'));
            cancelar.addEventListener('click', () => { confirmBox.innerHTML = ''; });
          });
        });
      });
    </script>
</body>
</html>